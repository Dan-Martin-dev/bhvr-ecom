# Codebase Audit & Fixes — 2026-01-08

Summary

- Performed a comprehensive audit for CONTEXT.md rule violations and best practices across the web app.
- Implemented fixes addressing: replacing raw `fetch()` calls with the RPC/client wrappers, removing `any` types and adding precise interfaces, adding lazy-loading and dimensions to images, adding debounced search, improving error handling, and creating missing UI primitives used by the checkout flow.

Files changed (high level)

- apps/web/src/lib/api.ts — added typed API helpers, `cartApi` (with guest session support), `productApi`, `checkoutApi`, and new TypeScript interfaces (`Product`, `ProductImage`, `Address`, filters).
- apps/web/src/lib/use-cart.ts — replaced fetch() calls with `cartApi` methods and simplified mutations.
- apps/web/src/lib/use-debounce.ts — new reusable `useDebounce` hook.
- apps/web/src/routes/(shop)/products/index.tsx — use `productApi.list`, added types, debounced search, fixed pagination references, added lazy images.
- apps/web/src/routes/(shop)/products/$slug.tsx — use `productApi.get`, added types, replaced cart fetch with `cartApi`, added lazy images and sizes.
- apps/web/src/routes/(shop)/cart.tsx — added lazy images for cart items.
- apps/web/src/routes/shop.checkout.tsx — replaced cart fetch with `cartApi.get`, added stronger type checks, fixed route usage (`/products`), and corrected imports & event types.
- apps/web/src/components/ui/radio-group.tsx — new Radix-based radio group component.
- apps/web/src/components/ui/textarea.tsx — new `Textarea` component.
- apps/web/src/lib/api.ts — (see above) type definitions and helper changes.

Key fixes and rationale

- fetch() → RPC/helpers: The app uses a type-safe Hono RPC client (`hc`). For endpoints that require custom guest session headers (cart endpoints), `cartApi` was implemented to keep session support while improving ergonomics.
- Type safety: Introduced `Product`, `ProductImage`, `Address`, and filter interfaces to remove `any` and align frontend types with server responses and validation schemas.
- Images: Added `loading="lazy"` and explicit `width`/`height` attributes wherever product images render to improve performance and layout stability.
- Debounce: Added a small `useDebounce` hook and wired it to product search to avoid excessive requests.
- Error handling: Added null guards (e.g., ensure `cart.id` exists before checkout) and more explicit error messages.
- Missing UI primitives: Created `radio-group` and `textarea` components used by the checkout page.
- Routing: Fixed paths to exclude route-group tokens (e.g., use `/products` not `/shop/products`).

How to verify locally

1. Install any new dependencies and run type checks:

```bash
cd bhvr-ecom
bun install
make check
```

2. Run the app in dev mode and exercise the product listing, product detail, cart, and checkout flows:

```bash
make dev
# open http://localhost:5173 (or the configured web dev port)
```

Notes / next actions

- Accessibility review is still pending: add ARIA labels and keyboard checks for interactive elements (todo item continues).
- Consider migrating `cartApi` further into the RPC client if a global mechanism for sending guest headers via the RPC client is introduced.

If you'd like, I can:

- Add a short checklist PR template for future audits.
- Run automated accessibility checks (axe) and surface items to fix.

---

Generated by the audit run on 2026-01-08.
